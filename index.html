<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Contingency Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f5f5;
    }
    header {
      background: #222;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    .container {
      max-width: 1000px;
      margin: 1rem auto;
      padding: 0 1rem;
    }
    .menu-btn {
      display: block;
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      background: #2979ff;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }
    .section {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,.1);
      margin-bottom: 1.5rem;
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      margin: 0.25rem 0 0.75rem 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      cursor: pointer;
    }
    .row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .grid {
      display: grid;
      gap: 0.75rem;
    }
    .block {
      background: #2979ff;
      color: #fff;
      padding: 1.25rem 0.5rem;
      text-align: center;
      border-radius: 8px;
      user-select: none;
    }
    .tracker-box {
      background: #f0f0f0;
      padding: 0.5rem;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.8rem;
    }
    .hidden {
      display: none;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    .small-btn {
      padding: 0.3rem 0.6rem;
      font-size: 0.75rem;
    }
    /* Reinforce overlay */
    #reinforce-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none; /* safety default */
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #reinforce-modal {
      background: #fff;
      padding: 2rem 2.5rem;
      border-radius: 12px;
      text-align: center;
      min-width: 260px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    #reinforce-modal h2 {
      margin-top: 0;
      color: #075e16;
    }
  </style>
</head>
<body>
  <header>
    <h1>Contingency Calculator</h1>
  </header>

  <!-- GLOBAL REINFORCE OVERLAY -->
  <div id="reinforce-overlay" class="hidden">
    <div id="reinforce-modal">
      <h2>REINFORCE</h2>
      <p>Reinforcement delivered.</p>
      <button onclick="hideReinforceOverlay()" class="menu-btn" style="background:#f44336;">X</button>
    </div>
  </div>

  <div class="container" id="app">

    <!-- Main Menu -->
    <div id="main-menu" class="section">
      <h2>Main Menu</h2>
      <button class="menu-btn" onclick="showView('variable-view')">Variable Schedule</button>
      <button class="menu-btn" onclick="showView('lag-view')">Lag Schedule</button>
      <button class="menu-btn" onclick="showView('percentile-view')">Percentile-Threshold Schedule</button>
      <button class="menu-btn" onclick="showView('frequency-view')">Frequency-based Schedule</button>
    </div>

    <!-- Variable Schedule View -->
    <div id="variable-view" class="section hidden">
      <div class="flex-between">
        <h2>Variable Schedule</h2>
        <button onclick="showView('main-menu')" class="small-btn">Main Menu</button>
      </div>
      <label>Variable Schedule (target avg):</label>
      <input type="number" id="var-target" min="1" />
      <label>Reinforcement opportunities (n):</label>
      <input type="number" id="var-n" min="1" />
      <button onclick="variableVM.updateSet()" class="menu-btn">Enter</button>
      <p id="var-error" style="color:red;"></p>
      <div id="var-current"></div>
      <div class="row" style="margin-top:1rem;">
        <button onclick="variableVM.handleCheckClick()" class="menu-btn" style="background:#4caf50;">âœ”</button>
        <button onclick="variableVM.handleXClick()" class="menu-btn" style="background:#f44336;">X</button>
      </div>
      <button onclick="toggleSection('var-tracker')" class="menu-btn" style="background:#777;margin-top:1rem;">Click Tracker</button>
      <div id="var-tracker" class="tracker-box hidden"></div>
      <button onclick="variableVM.copyClickData()" class="menu-btn" style="background:#2196f3;">Copy Click Tracker</button>
      <p id="var-copied" style="color:green;display:none;">Copied!</p>
    </div>

    <!-- Lag Schedule View -->
    <div id="lag-view" class="section hidden">
      <div class="flex-between">
        <h2>Lag Blocks</h2>
        <button onclick="showView('main-menu')" class="small-btn">Main Menu</button>
      </div>

      <div class="flex-between">
        <div style="flex:1;">
          <label>Block Count (1-50):</label>
          <input type="number" id="lag-block-count" min="1" max="50" value="4" />
          <button onclick="lagVM.setBlockCount()" class="small-btn">Set</button>
        </div>
        <div style="flex:1;">
          <label>Lag Schedule Input:</label>
          <input type="number" id="lag-input" min="1" value="3" />
          <button onclick="lagVM.setLag()" class="small-btn">Set</button>
        </div>
      </div>

      <div id="lag-blocks" class="grid" style="margin-top:1rem;"></div>

      <div style="margin-top:1rem;">
        <button onclick="toggleSection('lag-tracker')" class="menu-btn" style="background:#777;">Toggle Click Tracker</button>
      </div>
      <div id="lag-tracker" class="tracker-box hidden"></div>
      <button onclick="lagVM.copyClickData()" class="menu-btn" style="background:#2196f3;margin-top:0.5rem;">Copy Click Tracker</button>

      <div style="margin-top:1rem;">
        <button onclick="lagVM.saveSession()" class="small-btn">Save Session</button>
        <button onclick="lagVM.showLoad()" class="small-btn">Load Session</button>
        <button onclick="lagVM.undo()" class="small-btn" style="background:#e57373;">Undo</button>
        <button onclick="lagVM.redo()" class="small-btn" style="background:#81c784;">Redo</button>
      </div>
      <div id="lag-load-list" class="tracker-box hidden"></div>
    </div>

    <!-- Percentile-Threshold View -->
    <div id="percentile-view" class="section hidden">
      <div class="flex-between">
        <h2>Percentile-Threshold Schedule</h2>
        <button onclick="showView('main-menu')" class="small-btn">Main Menu</button>
      </div>
      <div style="margin-bottom:1rem;">
        <button onclick="percentileVM.addBehavior()" class="small-btn">Add Behavior</button>
        <label style="margin-left:1rem;">Median Window:</label>
        <input type="number" id="pct-window" value="10" min="1" style="width:4rem;" onchange="percentileVM.setWindow(this.value)" />
        <label style="margin-left:1rem;">Custom Median:</label>
        <input type="number" id="pct-custom" style="width:6rem;" onchange="percentileVM.setCustomMedian(this.value)" />
      </div>
      <div id="pct-list"></div>
      <div style="margin-top:1rem;">
        <span>Current Median: <strong id="pct-median">Calculating...</strong></span>
      </div>
      <button onclick="toggleSection('pct-log')" class="menu-btn" style="background:#777;margin-top:1rem;">Show/Hide Tracker</button>
      <div id="pct-log" class="tracker-box hidden"></div>
      <button onclick="percentileVM.copyClickData()" class="menu-btn" style="background:#2196f3;margin-top:0.5rem;">Copy Click Tracker</button>
    </div>

    <!-- Frequency-Based View -->
    <div id="frequency-view" class="section hidden">
      <div class="flex-between">
        <h2>Frequency-based Schedule</h2>
        <button onclick="showView('main-menu')" class="small-btn">Main Menu</button>
      </div>
      <div>
        <label>Frequency Threshold (%):</label>
        <input type="number" id="freq-threshold" value="50" min="1" max="100" onchange="frequencyVM.setThreshold(this.value)" />
      </div>

      <div id="freq-buttons" style="margin-top:1rem;"></div>

      <div style="margin-top:1rem;">
        <h3>Edit Buttons</h3>
        <div id="freq-editor"></div>
        <button onclick="frequencyVM.addButton()" class="small-btn" style="margin-top:0.5rem;">Add Button</button>
      </div>

      <button onclick="toggleSection('freq-log')" class="menu-btn" style="background:#777;margin-top:1rem;">Show Click Tracker</button>
      <div id="freq-log" class="tracker-box hidden"></div>
      <button onclick="frequencyVM.copyClickData()" class="menu-btn" style="background:#2196f3;margin-top:0.5rem;">Copy Click Tracker</button>
    </div>

  </div>

  <script>
    // safety: hide overlay on load
    window.addEventListener("load", () => {
      const ov = document.getElementById("reinforce-overlay");
      if (ov) ov.classList.add("hidden");
    });

    // global reinforce overlay
    function showReinforceOverlay() {
      const ov = document.getElementById("reinforce-overlay");
      ov.classList.remove("hidden");
      ov.style.display = "flex";
    }
    function hideReinforceOverlay() {
      const ov = document.getElementById("reinforce-overlay");
      ov.classList.add("hidden");
      ov.style.display = "none";
    }

    // View switching
    function showView(id) {
      const sections = ["main-menu", "variable-view", "lag-view", "percentile-view", "frequency-view"];
      sections.forEach(sec => {
        document.getElementById(sec).classList.add("hidden");
      });
      document.getElementById(id).classList.remove("hidden");
    }

    function toggleSection(id) {
      const el = document.getElementById(id);
      el.classList.toggle("hidden");
    }

    // -----------------------
    // Variable Schedule VM
    // -----------------------
    const variableVM = {
      n: 0,
      targetAvg: 0,
      currentSet: [],
      generatedSets: new Set(),
      repeatingSets: false,
      clickCount: 0,
      currentIndex: 0,
      clickData: [],

      updateSet() {
        const nVal = parseInt(document.getElementById("var-n").value, 10);
        const tVal = parseInt(document.getElementById("var-target").value, 10);
        const errorEl = document.getElementById("var-error");
        if (!nVal || !tVal || nVal <= 0 || tVal <= 0) {
          errorEl.textContent = "Please enter positive values for both fields.";
          return;
        }
        this.n = nVal;
        this.targetAvg = tVal;
        const target = this.n * this.targetAvg;
        const combo = this.findRandomCombination(this.n, target);
        if (combo) {
          errorEl.textContent = "";
          this.currentSet = combo;
          this.clickCount = 0;
          this.currentIndex = 0;
          this.log("New schedule generated");
          this.renderCurrentSet();
        } else {
          this.repeatingSets = true;
        }
      },
      findRandomCombination(n, target) {
        for (let i = 0; i < 1000; i++) {
          const combination = [];
          let sum = 0;
          while (combination.length < n - 1) {
            const remaining = n - combination.length;
            const maxPossible = Math.max(1, Math.floor((target - sum) / remaining));
            const randomValue = Math.floor(Math.random() * maxPossible) + 1;
            combination.push(randomValue);
            sum += randomValue;
          }
          combination.push(target - sum);
          combination.sort(() => Math.random() - 0.5);
          const key = [...combination].sort((a,b)=>a-b).join("-");
          if (this.repeatingSets || !this.generatedSets.has(key)) {
            this.generatedSets.add(key);
            return combination;
          }
        }
        return null;
      },
      handleCheckClick() {
        if (!this.currentSet.length) return;
        this.clickCount += 1;
        this.log("Check");
        if (this.clickCount >= this.currentSet[this.currentIndex]) {
          showReinforceOverlay();
          this.log("REINFORCE");
          this.clickCount = 0;
          this.currentIndex += 1;
          if (this.currentIndex >= this.currentSet.length) this.currentIndex = 0;
          this.renderCurrentSet();
        }
      },
      handleXClick() {
        this.log("X");
      },
      log(text) {
        this.clickData.push(text + " at " + new Date().toISOString());
        this.renderTracker();
      },
      renderCurrentSet() {
        const el = document.getElementById("var-current");
        if (!this.currentSet.length) {
          el.innerHTML = "";
          return;
        }
        const parts = this.currentSet.map((val, i) => {
          if (i === this.currentIndex) return `<strong>${val}</strong>`;
          return String(val);
        });
        el.innerHTML = `<h3>Reinforce after:</h3><p>${parts.join(", ")} responses</p>`;
      },
      renderTracker() {
        const el = document.getElementById("var-tracker");
        el.innerHTML = this.clickData.map(d => `<div>${d}</div>`).join("");
      },
      copyClickData() {
        const text = this.clickData.join("\n");
        navigator.clipboard.writeText(text).then(() => {
          const msg = document.getElementById("var-copied");
          msg.style.display = "block";
          setTimeout(() => msg.style.display = "none", 2000);
        });
      }
    };

    // -----------------------
    // Lag Blocks VM
    // -----------------------
    const lagVM = {
      blocks: [],
      clickTracker: [],
      blockCount: 4,
      lagScheduleInput: 3,
      recentClicks: [],
      undoStack: [],
      redoStack: [],

      init() {
        this.makeBlocks();
        this.renderBlocks();
      },
      makeBlocks() {
        this.blocks = Array.from({length: this.blockCount}, (_,i) => ({
          id: crypto.randomUUID(),
          name: "Block " + (i+1)
        }));
      },
      setBlockCount() {
        const val = parseInt(document.getElementById("lag-block-count").value,10);
        if (val >=1 && val <=50) {
          this.saveState();
          this.blockCount = val;
          this.makeBlocks();
          this.log(`Block count changed to ${val}`);
          this.renderBlocks();
        }
      },
      setLag() {
        const val = parseInt(document.getElementById("lag-input").value,10);
        if (val > 0) {
          this.saveState();
          this.lagScheduleInput = val;
          this.log(`Lag schedule changed to ${val}`);
        }
      },
      renderBlocks() {
        const container = document.getElementById("lag-blocks");
        const cols = Math.round(Math.sqrt(this.blockCount));
        container.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
        container.innerHTML = "";
        this.blocks.forEach(block => {
          const div = document.createElement("div");
          div.className = "block";
          div.textContent = block.name;
          div.onclick = () => this.blockClicked(block);
          div.ondblclick = (e) => {
            e.stopPropagation();
            const newName = prompt("Enter new block name:", block.name);
            if (newName && newName.trim() !== "") {
              this.renameBlock(block.id, newName.trim());
            }
          };
          container.appendChild(div);
        });
        this.renderTracker();
      },
      renameBlock(id, newName) {
        const idx = this.blocks.findIndex(b => b.id === id);
        if (idx !== -1) {
          this.saveState();
          this.blocks[idx].name = newName;
          this.renderBlocks();
          this.log(`Block renamed to ${newName}`);
        }
      },
      blockClicked(block) {
        this.saveState();
        this.recentClicks.push(block);
        if (this.recentClicks.length > this.lagScheduleInput + 1) {
          this.recentClicks.shift();
        }
        if (this.recentClicks.length === this.lagScheduleInput + 1) {
          const lagWindow = this.recentClicks.slice(0, this.lagScheduleInput);
          const invariant = lagWindow.some(b => b.id === block.id);
          if (invariant) {
            this.log("[INVARIANT]");
            this.renderTracker();
          } else {
            showReinforceOverlay();
            this.log(`Reinforced ${block.name} at ${new Date().toISOString()}`);
            this.log(`[*NEW LAG WINDOW] ${this.recentClicks.slice(-this.lagScheduleInput).map(b=>b.name).join(", ")}`);
            this.renderTracker();
          }
        } else {
          this.log(`${block.name} clicked at ${new Date().toISOString()}`);
          this.renderTracker();
        }
      },
      log(text) {
        this.clickTracker.push(text);
      },
      renderTracker() {
        const el = document.getElementById("lag-tracker");
        el.innerHTML = this.clickTracker.map(t => `<div>${t}</div>`).join("");
      },
      copyClickData() {
        const text = this.clickTracker.join("\n");
        navigator.clipboard.writeText(text);
      },
      saveSession() {
        const sessionData = {
          clickTracker: this.clickTracker,
          blocks: this.blocks,
          blockCount: this.blockCount,
          lagScheduleInput: this.lagScheduleInput
        };
        const name = "lagblocks_session_" + crypto.randomUUID();
        localStorage.setItem(name, JSON.stringify(sessionData));
        alert("Session saved.");
      },
      showLoad() {
        const list = document.getElementById("lag-load-list");
        list.classList.toggle("hidden");
        if (!list.classList.contains("hidden")) {
          list.innerHTML = "";
          Object.keys(localStorage)
            .filter(k => k.startsWith("lagblocks_session_"))
            .forEach(k => {
              const btn = document.createElement("button");
              btn.textContent = k.replace("lagblocks_session_","");
              btn.className = "small-btn";
              btn.onclick = () => this.loadSession(k);
              list.appendChild(btn);
              list.appendChild(document.createElement("br"));
            });
        }
      },
      loadSession(key) {
        const data = localStorage.getItem(key);
        if (!data) return;
        const session = JSON.parse(data);
        this.clickTracker = session.clickTracker;
        this.blocks = session.blocks;
        this.blockCount = session.blockCount;
        this.lagScheduleInput = session.lagScheduleInput;
        document.getElementById("lag-block-count").value = this.blockCount;
        document.getElementById("lag-input").value = this.lagScheduleInput;
        this.renderBlocks();
        this.renderTracker();
        alert("Session loaded.");
      },
      saveState() {
        const copy = {
          clickTracker: [...this.clickTracker],
          blocks: JSON.parse(JSON.stringify(this.blocks)),
          blockCount: this.blockCount,
          lagScheduleInput: this.lagScheduleInput
        };
        this.undoStack.push(copy);
        this.redoStack = [];
      },
      undo() {
        const prev = this.undoStack.pop();
        if (!prev) return;
        const current = {
          clickTracker: [...this.clickTracker],
          blocks: JSON.parse(JSON.stringify(this.blocks)),
          blockCount: this.blockCount,
          lagScheduleInput: this.lagScheduleInput
        };
        this.redoStack.push(current);
        this.clickTracker = prev.clickTracker;
        this.blocks = prev.blocks;
        this.blockCount = prev.blockCount;
        this.lagScheduleInput = prev.lagScheduleInput;
        document.getElementById("lag-block-count").value = this.blockCount;
        document.getElementById("lag-input").value = this.lagScheduleInput;
        this.renderBlocks();
      },
      redo() {
        const next = this.redoStack.pop();
        if (!next) return;
        this.saveState();
        this.clickTracker = next.clickTracker;
        this.blocks = next.blocks;
        this.blockCount = next.blockCount;
        this.lagScheduleInput = next.lagScheduleInput;
        document.getElementById("lag-block-count").value = this.blockCount;
        document.getElementById("lag-input").value = this.lagScheduleInput;
        this.renderBlocks();
      }
    };

    // -----------------------
    // Percentile VM
    // -----------------------
    const percentileVM = {
      behaviors: [],
      median: 0,
      medianWindow: 10,
      customMedian: null,
      inputLog: {},
      eventLog: [],

      addBehavior() {
        const id = crypto.randomUUID();
        const behavior = { id, name: "New Behavior" };
        this.behaviors.push(behavior);
        this.inputLog[id] = [];
        this.renderBehaviors();
      },
      removeBehavior(id) {
        this.behaviors = this.behaviors.filter(b => b.id !== id);
        delete this.inputLog[id];
        this.renderBehaviors();
      },
      setWindow(val) {
        const num = parseInt(val, 10);
        if (num > 0) {
          this.medianWindow = num;
          this.recalculateMedian();
          this.renderMedian();
        }
      },
      setCustomMedian(val) {
        const num = parseFloat(val);
        if (!isNaN(num) && num !== 0) {
          this.customMedian = num;
        } else {
          this.customMedian = null;
        }
        this.renderMedian();
      },
      submitInput(id) {
        const inputEl = document.getElementById("pct-input-" + id);
        const val = parseFloat(inputEl.value);
        if (isNaN(val)) return;
        this.inputLog[id].push(val);
        inputEl.value = "";
        this.recalculateMedian();
        this.checkReinforcement(id, val);
        const beh = this.behaviors.find(b => b.id === id);
        this.log(`Input for ${beh ? beh.name : "Unknown"} at ${new Date().toISOString()}: ${val}`);
        this.renderMedian();
        this.renderLog();
      },
      recalculateMedian() {
        const all = Object.values(this.inputLog).flatMap(arr => arr.slice(-this.medianWindow));
        if (all.length >= this.medianWindow) {
          const sorted = [...all].sort((a,b)=>a-b);
          const mid = Math.floor(sorted.length / 2);
          if (sorted.length % 2 === 0) {
            this.median = (sorted[mid - 1] + sorted[mid]) / 2;
          } else {
            this.median = sorted[mid];
          }
        } else {
          this.median = 0;
        }
      },
      checkReinforcement(id, value) {
        let threshold;
        if (this.customMedian && this.customMedian !== 0 && this.median > 0) {
          threshold = Math.max(this.customMedian, this.median);
        } else if (this.customMedian && this.customMedian !== 0) {
          threshold = this.customMedian;
        } else if (this.medianWindow !== 0 && this.median > 0) {
          threshold = this.median;
        } else {
          return;
        }
        if (value > threshold) {
          this.log(`Reinforced ${this.behaviors.find(b=>b.id===id)?.name || "Unknown"} at ${new Date().toISOString()}`);
          showReinforceOverlay();
        }
      },
      log(msg) {
        this.eventLog.push(msg);
      },
      renderBehaviors() {
        const list = document.getElementById("pct-list");
        list.innerHTML = "";
        this.behaviors.forEach(b => {
          const div = document.createElement("div");
          div.className = "section";
          div.style.padding = "0.5rem";
          div.innerHTML = `
            <div class="flex-between">
              <input type="text" value="${b.name}" onchange="percentileVM.renameBehavior('${b.id}', this.value)" style="flex:1;margin-right:1rem;" />
              <button class="small-btn" onclick="percentileVM.removeBehavior('${b.id}')">Remove</button>
            </div>
            <div class="flex-between" style="margin-top:0.5rem;">
              <input type="number" id="pct-input-${b.id}" placeholder="Enter value" style="flex:1;margin-right:1rem;" />
              <button class="small-btn" onclick="percentileVM.submitInput('${b.id}')">Enter</button>
            </div>
          `;
          list.appendChild(div);
        });
      },
      renameBehavior(id, newName) {
        const b = this.behaviors.find(b=>b.id===id);
        if (b) b.name = newName;
      },
      renderMedian() {
        const el = document.getElementById("pct-median");
        let displayed;
        if (this.customMedian && this.customMedian !== 0) {
          displayed = this.median > this.customMedian ? this.median : this.customMedian;
        } else if (this.median > 0) {
          displayed = this.median;
        } else {
          displayed = "Calculating...";
        }
        el.textContent = typeof displayed === "number" ? displayed.toFixed(2) : displayed;
      },
      renderLog() {
        const el = document.getElementById("pct-log");
        el.innerHTML = this.eventLog.map(e => `<div>${e}</div>`).join("");
      },
      copyClickData() {
        const text = this.eventLog.join("\n");
        navigator.clipboard.writeText(text);
      }
    };

    // -----------------------
    // Frequency-based VM
    // -----------------------
    const frequencyVM = {
      buttonNames: ["Behavior 1", "Behavior 2"],
      buttonClicks: [0, 0],
      frequencyThreshold: 50,
      trackerLog: [],

      init() {
        this.renderButtons();
        this.renderEditor();
      },
      setThreshold(val) {
        const num = parseInt(val, 10);
        if (!isNaN(num)) {
          this.frequencyThreshold = num;
          this.log(`Frequency threshold changed to ${num}%.`);
          this.renderLog();
        }
      },
      renderButtons() {
        const container = document.getElementById("freq-buttons");
        container.innerHTML = "";
        this.buttonNames.forEach((name, index) => {
          const btn = document.createElement("button");
          btn.textContent = name;
          btn.className = "menu-btn";
          btn.onclick = () => this.handleClick(index);
          container.appendChild(btn);
        });
      },
      renderEditor() {
        const editor = document.getElementById("freq-editor");
        editor.innerHTML = "";
        this.buttonNames.forEach((name, index) => {
          const row = document.createElement("div");
          row.className = "flex-between";
          row.style.marginBottom = "0.4rem";
          row.innerHTML = `
            <input type="text" value="${name}" style="flex:1;margin-right:0.5rem;" onchange="frequencyVM.renameButton(${index}, this.value)" />
            <button class="small-btn" onclick="frequencyVM.removeButton(${index})">Remove</button>
          `;
          editor.appendChild(row);
        });
      },
      handleClick(index) {
        this.buttonClicks[index] += 1;
        const totalClicks = this.buttonClicks.reduce((a,b)=>a+b,0);
        const relFreq = totalClicks > 0 ? (this.buttonClicks[index]/totalClicks)*100 : 0;
        const ts = new Date().toISOString();
        if (relFreq <= this.frequencyThreshold) {
          showReinforceOverlay();
          this.log(`[${ts}] REINFORCE triggered for ${this.buttonNames[index]}.`);
        }
        this.log(`[${ts}] ${this.buttonNames[index]} clicked. Relative Frequency: ${relFreq.toFixed(2)}%.`);
        this.renderLog();
      },
      addButton() {
        this.buttonNames.push("New Behavior");
        this.buttonClicks.push(0);
        this.log(`[${new Date().toISOString()}] Added new button: New Behavior.`);
        this.renderButtons();
        this.renderEditor();
        this.renderLog();
      },
      renameButton(index, newName) {
        this.buttonNames[index] = newName;
        this.renderButtons();
        this.log(`[${new Date().toISOString()}] Renamed button ${index+1} to ${newName}.`);
        this.renderLog();
      },
      removeButton(index) {
        if (this.buttonNames.length === 1) return;
        const ts = new Date().toISOString();
        this.log(`[${ts}] Removed button: ${this.buttonNames[index]}.`);
        this.buttonNames.splice(index,1);
        this.buttonClicks.splice(index,1);
        this.renderButtons();
        this.renderEditor();
        this.renderLog();
      },
      log(msg) {
        this.trackerLog.push(msg);
      },
      renderLog() {
        const el = document.getElementById("freq-log");
        el.innerHTML = this.trackerLog.map(l => `<div>${l}</div>`).join("");
      },
      copyClickData() {
        const text = this.trackerLog.join("\n");
        navigator.clipboard.writeText(text);
      }
    };

    // init
    lagVM.init();
    percentileVM.renderBehaviors();
    percentileVM.renderMedian();
    frequencyVM.init();
  </script>
</body>
</html>
